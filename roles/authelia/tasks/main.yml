- name: Check Authelia secrets present
  assert:
    that:
      - vault_authelia_jwt_secret is string
      - vault_authelia_session_secret is string
      - vault_authelia_storage_encryption_key is string
      - vault_authelia_users is iterable
      - vault_authelia_users is defined
      - vault_authelia_users | length > 0
    fail_msg: "Authelia Secrets/Users missing â€“ Please add to secrets.yml."

- name: Ensure Authelia directories
  ansible.builtin.file:
    path: "{{ authelia.root }}"
    state: directory
    mode: "0755"

- name: Render configuration.yml
  ansible.builtin.template:
    src: configuration.yml.j2
    dest: "{{ authelia.root }}/configuration.yml"
    mode: "0640"

- name: Render users_database.yml
  ansible.builtin.template:
    src: users_database.yml.j2
    dest: "{{ authelia.root }}/users_database.yml"
    mode: "0600"

- name: Render compose.yml
  ansible.builtin.template:
    src: compose.yml.j2
    dest: "{{ authelia.root }}/compose.yml"
    mode: "0644"

- name: Ensure external docker network exists
  community.docker.docker_network:
    name: "{{ authelia.network }}"
    state: present

- name: Deploy Authelia (compose v2)
  community.docker.docker_compose_v2:
    project_src: "{{ authelia.root }}"
    files: ["compose.yml"]
    state: present
    pull: always
